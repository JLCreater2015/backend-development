# Linuxè¿›ç¨‹è°ƒåº¦ç®—æ³•



## âœ è¿›ç¨‹æŒ‚èµ·

æˆ‘ä»¬ä¸€èˆ¬è®¤ä¸ºè¿›ç¨‹æœ‰äº”ä¸ªçŠ¶æ€ï¼Œå³æ–°å»ºæ€ï¼Œå°±ç»ªæ€ï¼Œé˜»å¡æ€ï¼Œè¿è¡Œæ€ï¼Œç»ˆæ­¢æ€ã€‚è€Œåœ¨è¿™äº›çŠ¶æ€ä¹‹å¤–è¿˜å­˜åœ¨ç€ä¸€ä¸ªçŠ¶æ€ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæŒ‚èµ·çŠ¶æ€ï¼Œå®ƒæ—¢å¯ä»¥æ˜¯æˆ‘ä»¬å®¢æˆ·ä¸»åŠ¨ä½¿å¾—è¿›ç¨‹æŒ‚èµ·ï¼Œä¹Ÿå¯ä»¥æ˜¯æ“ä½œç³»ç»Ÿå› ä¸ºæŸäº›åŸå› ä½¿å¾—è¿›ç¨‹æŒ‚èµ·ã€‚æ€»è€Œè¨€ä¹‹å¼•å…¥æŒ‚èµ·çŠ¶æ€çš„åŸå› æœ‰ä»¥ä¸‹å‡ ç§ï¼š

1. ç”¨æˆ·çš„è¯·æ±‚ï¼šå¯èƒ½æ˜¯åœ¨ç¨‹åºè¿è¡ŒæœŸé—´å‘ç°äº†å¯ç–‘çš„é—®é¢˜ï¼Œéœ€è¦æš‚åœè¿›ç¨‹ã€‚ 
2. çˆ¶è¿›ç¨‹çš„è¯·æ±‚ï¼šè€ƒå¯Ÿï¼Œåè°ƒï¼Œæˆ–ä¿®æ”¹å­è¿›ç¨‹ã€‚ 
3. æ“ä½œç³»ç»Ÿçš„éœ€è¦ï¼šå¯¹è¿è¡Œä¸­èµ„æºçš„ä½¿ç”¨æƒ…å†µè¿›è¡Œæ£€æŸ¥å’Œè®°è´¦ã€‚ 
4. è´Ÿè½½è°ƒèŠ‚çš„éœ€è¦ï¼šæœ‰ä¸€äº›å®æ—¶çš„ä»»åŠ¡éå¸¸é‡è¦ï¼Œéœ€è¦å¾—åˆ°å……è¶³çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠéå®æ—¶çš„ä»»åŠ¡è¿›è¡ŒæŒ‚èµ·ï¼Œä¼˜å…ˆä½¿å¾—å®æ—¶ä»»åŠ¡æ‰§è¡Œã€‚ 
5. å®šæ—¶ä»»åŠ¡ï¼šä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¼šå‘¨æœŸæ€§çš„æ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆåœ¨ä¸€æ¬¡æ‰§è¡Œå®Œæ¯•åæŒ‚èµ·è€Œä¸æ˜¯é˜»å¡ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå†…å­˜ã€‚ 
6. å®‰å…¨ï¼šç³»ç»Ÿæœ‰æ—¶å¯èƒ½ä¼šå‡ºç°æ•…éšœæˆ–è€…æŸäº›åŠŸèƒ½å—åˆ°ç ´åï¼Œè¿™æ˜¯å°±éœ€è¦å°†ç³»ç»Ÿä¸­æ­£åœ¨è¿›è¡Œçš„è¿›ç¨‹è¿›è¡ŒæŒ‚èµ·ï¼Œå½“ç³»ç»Ÿæ•…éšœæ¶ˆé™¤ä»¥åï¼Œå¯¹è¿›ç¨‹çš„çŠ¶æ€è¿›è¡Œæ¢å¤ã€‚ 

æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†æŒ‚èµ·çŠ¶æ€å¼•å…¥çš„åŸå› ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹çœ‹å¸¦æœ‰æŒ‚èµ·çŠ¶æ€çš„è¿›ç¨‹çŠ¶æ€è½¬ç§»è¿‡ç¨‹ï¼š

![](../../.gitbook/assets/image%20%2816%29.png)

ç›¸æ¯”äºä¸€èˆ¬çš„äº”ä¸ªçŠ¶æ€çš„è¿›ç¨‹çŠ¶æ€è½¬ç§»å›¾ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸¤ç§æŒ‚èµ·çŠ¶æ€çš„ç±»å‹ï¼Œå³å°±ç»ªæŒ‚èµ·çŠ¶æ€å’Œé˜»å¡æŒ‚èµ·çŠ¶æ€ã€‚å®ƒä»¬çš„åŒºåˆ«å°±æ˜¯å°±ç»ªæŒ‚èµ·çŠ¶æ€å…¶å®è¿˜æ˜¯åœ¨å†…å­˜ä¸­çš„ï¼Œè€Œåè€…æ˜¯åœ¨å¤–å­˜ä¸­çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸€è¯´æ–°åŠ å…¥çš„å‡ ä¸ªçŠ¶æ€è½¬åŒ–çš„æ­¥éª¤ï¼š

1. è¿è¡ŒçŠ¶æ€-&gt;å°±ç»ªæŒ‚èµ·çŠ¶æ€ï¼šè¿™é‡Œå‘ç”Ÿåœ¨å®¢æˆ·åœ¨ç¨‹åºæ­£åœ¨è¿è¡Œæ˜¯ç›´æ¥æŒ‚èµ·ç¨‹åºã€‚æ³¨æ„è¿™é‡Œçš„ç®­å¤´æ˜¯å•å‘çš„ï¼Œæ‰€ä»¥åœ¨å°±ç»ªæŒ‚èµ·çŠ¶æ€ç»“æŸä»¥åå®é™…ä¸Šæ˜¯æ‰§è¡Œæ¿€æ´»æ­¥éª¤ï¼Œè¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œç­‰å¾…å¤„ç†æœºè°ƒåº¦ã€‚ 
2. é˜»å¡çŠ¶æ€-&gt;é˜»å¡æŒ‚èµ·çŠ¶æ€ï¼šå½“å†…å­˜ç©ºé—´æ¯”è¾ƒç´§ç¼ºçš„æ—¶å€™ï¼Œå¦‚æœæœ‰å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œè€Œä¸”æ˜¯å¤„äºé˜»å¡çŠ¶æ€çš„è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±è®©ä»–æ›´éœ€è¦å†…å­˜çš„ç¨‹åºå ç”¨å†…å­˜ï¼Œè‡ªå·±è¿›å…¥é˜»å¡æŒ‚èµ·çŠ¶æ€ï¼ŒPCBç­‰æ•°æ®å­˜å…¥å¤–å­˜ã€‚å› ä¸ºç°åœ¨è¿™ä¸ªè¿›ç¨‹ä¹Ÿä¸èƒ½è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œè¿™ä¸ªç¨‹åºåœ¨å†…å­˜ä¸­æ˜¯æ²¡æœ‰ä»€ä¹ˆä½œç”¨çš„ã€‚
3. é˜»å¡æŒ‚èµ·çŠ¶æ€-&gt;å°±ç»ªæŒ‚èµ·çŠ¶æ€ï¼šå½“é˜»å¡çŠ¶æ€ç­‰å¾…çš„IOäº‹ä»¶æˆ–å…¶ä»–äº‹ä»¶åˆ°æ¥çš„æ—¶å€™çŠ¶æ€å‘ç”Ÿæ”¹å˜ã€‚ 
4. å°±ç»ªæŒ‚èµ·çŠ¶æ€-&gt;å°±ç»ªçŠ¶æ€ï¼šå¦‚æœå†…å­˜ä¸­æ²¡æœ‰å°±ç»ªæ€è¿›ç¨‹ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦è°ƒå…¥ä¸€ä¸ªè¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚æ­¤å¤–ï¼Œå½“å¤„äºå°±ç»ª/æŒ‚èµ·çŠ¶æ€çš„è¿›ç¨‹æ¯”å¤„äºå°±ç»ªæ€çš„ä»»ä½•è¿›ç¨‹çš„ä¼˜å…ˆçº§éƒ½è¦é«˜æ—¶ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè¿™ç§è½¬æ¢ã€‚è¿™ç§æƒ…å†µçš„äº§ç”Ÿæ˜¯ç”±äºæ“ä½œç³»ç»Ÿè®¾è®¡è€…è§„å®šï¼Œè°ƒå…¥é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹æ¯”å‡å°‘äº¤æ¢é‡æ›´é‡è¦ã€‚ 
5. å°±ç»ªçŠ¶æ€-&gt;å°±ç»ªæŒ‚èµ·çŠ¶æ€ï¼šé€šå¸¸ï¼Œæ“ä½œç³»ç»Ÿæ›´å€¾å‘äºæŒ‚èµ·é˜»å¡æ€è¿›ç¨‹è€Œä¸æ˜¯å°±ç»ªæ€è¿›ç¨‹ï¼Œå› ä¸ºå°±ç»ªæ€è¿›ç¨‹å¯ä»¥ç«‹å³æ‰§è¡Œï¼Œè€Œé˜»å¡æ€è¿›ç¨‹å ç”¨äº†å†…å­˜ç©ºé—´ä½†ä¸èƒ½æ‰§è¡Œã€‚ä½†å¦‚æœé‡Šæ”¾å†…å­˜ä»¥å¾—åˆ°è¶³å¤Ÿç©ºé—´çš„å”¯ä¸€æ–¹æ³•æ˜¯æŒ‚èµ·ä¸€ä¸ªå°±ç»ªæ€è¿›ç¨‹ï¼Œé‚£ä¹ˆè¿™ç§è½¬æ¢ä¹Ÿæ˜¯å¿…éœ€çš„ã€‚å¹¶ä¸”ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿç¡®ä¿¡é«˜ä¼˜å…ˆçº§çš„é˜»å¡æ€è¿›ç¨‹å¾ˆå¿«å°±ä¼šå°±ç»ªï¼Œé‚£ä¹ˆå®ƒå¯èƒ½é€‰æ‹©æŒ‚èµ·ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„å°±ç»ªæ€è¿›ç¨‹ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„é˜»å¡æ€è¿›ç¨‹ã€‚

### ğŸ–‹ æŒ‚èµ·å’Œé˜»å¡çš„åŒºåˆ«

1. **æ˜¯å¦é‡Šæ”¾CPUï¼š**é˜»å¡ï¼ˆpendï¼‰å°±æ˜¯ä»»åŠ¡é‡Šæ”¾CPUï¼Œå…¶ä»–ä»»åŠ¡å¯ä»¥è¿è¡Œï¼Œä¸€èˆ¬åœ¨ç­‰å¾…æŸç§èµ„æºæˆ–ä¿¡å·é‡çš„æ—¶å€™å‡ºç°ã€‚æŒ‚èµ·ï¼ˆsuspendï¼‰ä¸é‡Šæ”¾CPUï¼Œå¦‚æœä»»åŠ¡ä¼˜å…ˆçº§é«˜å°±æ°¸è¿œè½®ä¸åˆ°å…¶ä»–ä»»åŠ¡è¿è¡Œã€‚ä¸€èˆ¬æŒ‚èµ·ç”¨äºç¨‹åºè°ƒè¯•ä¸­çš„æ¡ä»¶ä¸­æ–­ï¼Œå½“å‡ºç°æŸä¸ªæ¡ä»¶çš„æƒ…å†µä¸‹æŒ‚èµ·ï¼Œç„¶åè¿›è¡Œå•æ­¥è°ƒè¯•ã€‚
2. **æ˜¯å¦ä¸»åŠ¨ï¼š**æ˜¾ç„¶é˜»å¡æ˜¯ä¸€ç§**è¢«åŠ¨è¡Œä¸º**ï¼Œå…¶å‘ç”Ÿåœ¨**ç£ç›˜ï¼Œç½‘ç»œIOï¼Œwaitï¼Œlock**ç­‰è¦ç­‰å¾…æŸç§äº‹ä»¶çš„å‘ç”Ÿçš„æ“ä½œä¹‹åã€‚å› ä¸ºæ‹¿ä¸åˆ°IOèµ„æºï¼Œæ‰€ä»¥é˜»å¡æ—¶ä¼šæ”¾å¼ƒ CPUçš„å ç”¨ã€‚è€ŒæŒ‚èµ·æ˜¯ä¸»åŠ¨çš„ï¼Œå› ä¸ºæŒ‚èµ·åè¿˜è¦å—åˆ°CPUçš„ç›‘ç£ï¼ˆç­‰å¾…ç€æ¿€æ´»ï¼‰ï¼Œæ‰€ä»¥æŒ‚èµ·ä¸é‡Šæ”¾CPUï¼Œæ¯”å¦‚sleepå‡½æ•°ï¼Œç«™ç€CPUä¸ä½¿ç”¨ã€‚
3. **ä¸è°ƒåº¦å™¨æ˜¯å¦ç›¸å…³ï¼š**ä»»åŠ¡è°ƒåº¦æ˜¯æ“ä½œç³»ç»Ÿæ¥å®ç°çš„ï¼Œä»»åŠ¡è°ƒåº¦æ—¶ï¼Œç›´æ¥å¿½ç•¥æŒ‚èµ·çŠ¶æ€çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šé¡¾åŠå¤„äºpendä¸‹çš„ä»»åŠ¡ï¼Œå½“pendä¸‹çš„ä»»åŠ¡ç­‰å¾…çš„èµ„æºå°±ç»ªåï¼Œå°±å¯ä»¥è½¬ä¸ºreadyäº†ã€‚readyåªéœ€è¦ç­‰å¾…CPUæ—¶é—´ï¼Œå½“ç„¶ï¼Œä»»åŠ¡è°ƒåº¦ä¹Ÿå ç”¨å¼€é”€ï¼Œä½†æ˜¯ä¸å¤§ï¼Œå¯ä»¥å¿½ç•¥ã€‚å¯ä»¥è¿™æ ·ç†è§£ï¼Œåªè¦æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œæ“ä½œç³»ç»Ÿå°±ä¸åœ¨ç®¡ç†è¿™ä¸ªä»»åŠ¡äº†ã€‚

#### `sleep()`å’Œ`wait()`å‡½æ•°çš„åŒºåˆ«ï¼š

1. **ä¸¤è€…æ¯”è¾ƒçš„å…±åŒä¹‹å¤„æ˜¯ï¼šä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ä½¿ç¨‹åºç­‰å¾…å¤šå°‘æ¯«ç§’**ã€‚
2. **æœ€ä¸»è¦åŒºåˆ«æ˜¯ï¼šsleep\(\)æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ã€‚è€Œwait\(\)æ–¹æ³•é‡Šæ”¾äº†é”ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨åŒæ­¥æ§åˆ¶å—æˆ–è€…æ–¹æ³•**ã€‚
3. **sleep\(\)æŒ‡çº¿ç¨‹è¢«è°ƒç”¨æ—¶ï¼Œå ç€CPUä¸å·¥ä½œï¼Œå½¢è±¡çš„è¯´æ˜ä¸ºâ€œå ç€CPUâ€ç¡è§‰**ã€‚

### ğŸ–‹ è¿›ç¨‹ä¸»åŠ¨æŒ‚èµ·ï¼ˆsleepï¼‰

è¿›ç¨‹å¯ä»¥è®©è‡ªå·±æŒ‚èµ·ï¼Œç­‰åˆ°ä¸€å®šæ—¶é—´åï¼Œè¢«ç³»ç»Ÿå”¤é†’ï¼ˆæ—¶é—´åˆ°æˆ–è€…æ”¶åˆ°ä¿¡å·ï¼‰ã€‚è¿™ä¸ªèƒ½åŠ›ç”±sleepå‡½æ•°æä¾›ã€‚

```c
unsigned int sleep(unsigned int seconds); 
```

è¿™ä¸ªå‡½æ•°å¯ä»¥è®©è¿›ç¨‹è‡ªå·±æŒ‚èµ·secondsç§’ï¼Œsleepå‡½æ•°æ˜¯ç”±æ“ä½œç³»ç»Ÿçš„ `nanosleep` å‡½æ•°å®ç°çš„ï¼Œ`On Linux, sleep() is implemented via nanosleep(2). See the nanosleep(2) man page for a discussion of the clock used.`æ ¸å¿ƒä»£ç ï¼š

```c
asmlinkage long sys_nanosleep(struct timespec __user *rqtp, 
                              struct timespec __user *rmtp)
{
	struct timespec t;
	unsigned long expire;
	long ret;

	expire = timespec_to_jiffies(&t) + (t.tv_sec || t.tv_nsec);
	current->state = TASK_INTERRUPTIBLE;
	expire = schedule_timeout(expire);
}
// ç®—å‡ºè¶…æ—¶æ—¶é—´ï¼Œç„¶åæŒ‚èµ·è¿›ç¨‹ï¼ˆå¯ä¸­æ–­æŒ‚èµ·ï¼‰ï¼Œç„¶åè°ƒç”¨schedule_timeoutã€‚
```

```c
fastcall signed long __sched schedule_timeout(signed long timeout)
{
	struct timer_list timer;
	unsigned long expire;
	// ç®—å‡ºè¶…æ—¶æ—¶é—´
	expire = timeout + jiffies;

	init_timer(&timer);
	// è¶…æ—¶æ—¶é—´
	timer.expires = expire;
	timer.data = (unsigned long) current;
	// è¶…æ—¶å›è°ƒ
	timer.function = process_timeout;
	// æ·»åŠ å®šæ—¶å™¨
	add_timer(&timer);
	// è¿›ç¨‹è°ƒåº¦
	schedule();
	// åˆ é™¤å®šæ—¶å™¨
	del_singleshot_timer_sync(&timer);
    // è¶…æ—¶æˆ–è€…è¢«ä¿¡å·å”¤é†’ï¼Œè¢«ä¿¡å·å”¤é†’çš„è¯ï¼Œå¯èƒ½è¿˜æ²¡æœ‰è¶…æ—¶
	timeout = expire - jiffies;

out:
	return timeout < 0 ? 0 : timeout;
}
```

æ¥ç€å¾€ç³»ç»Ÿæ–°å¢ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç„¶åå‘é€è¿›ç¨‹è°ƒåº¦ï¼Œè¯¥è¿›ç¨‹éšå³è¿›å…¥æŒ‚èµ·çŠ¶æ€ã€‚ç­‰åˆ°ä¸€å®šçš„æ—¶é—´åï¼Œè¿›ç¨‹ä¼šå”¤é†’ã€‚å¦å¤–æˆ‘ä»¬æ³¨æ„åˆ°æŒ‚èµ·çš„è¿›ç¨‹çŠ¶æ€æ˜¯`TASK_INTERRUPTIBLE`ï¼Œå³å¯ä¸­æ–­çš„ã€‚æ„æ€æ˜¯è¿™ç§çŠ¶æ€çš„è¿›ç¨‹å¯ä»¥è¢«ä¿¡å·å”¤é†’ã€‚è€Œ`TASK_UNINTERRUPTIBLE`æ˜¯ä¸èƒ½è¢«ä¿¡å·å”¤é†’çš„ï¼Œç­‰åˆ°è¶…æ—¶çš„æ—¶å€™ï¼Œæ‰§è¡Œ`process_timeout`å‡½æ•°ï¼š

```c
static void process_timeout(unsigned long __data)
{
	wake_up_process((task_t *)__data);
}
```

ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯å”¤é†’è¢«æŒ‚èµ·çš„è¿›ç¨‹ã€‚`__data`æ˜¯åœ¨`timer.data = (unsigned long) current;` ä¸­è®¾ç½®çš„ã€‚

