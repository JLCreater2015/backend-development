# çº¿ç¨‹

## âœ 1ã€`fork & vfork`

### ğŸ–‹ 1ã€å‡½æ•°fork\(\)

forkå‡½æ•°ï¼šåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹

1. fork\(\)æˆåŠŸåï¼Œå°†ä¸ºå­è¿›ç¨‹ç”³è¯·PCBå’Œç”¨æˆ·å†…å­˜ç©ºé—´ã€‚
2. å­è¿›ç¨‹ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹ç”¨æˆ·ç©ºé—´çš„æ‰€æœ‰æ•°æ®\(ä»£ç æ®µã€æ•°æ®æ®µã€BSSã€å †ã€æ ˆ\)ï¼Œæ–‡ä»¶æè¿°ç¬¦ã€‚
3. å¤åˆ¶çˆ¶äº²è¿›ç¨‹PCBä¸­ç»å¤§å¤šæ•°ä¿¡æ¯ã€‚
4. è™½ç„¶å­è¿›ç¨‹å¤åˆ¶äº†æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œå¯¹äºæ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„æ–‡ä»¶è¡¨é¡¹\(struct fileç»“æ„\)ï¼Œåˆ™é‡‡ç”¨å…±äº«çš„æ–¹å¼ã€‚è¿™ä¹Ÿæ˜¯çˆ¶å­è¿›ç¨‹è¿›è¡Œpipeäº’ç›¸é€šä¿¡çš„åŸºç¡€ã€‚

```cpp
#include<sys/types.h>
#include<unistd.h>
#include<stdio.h>
 
int main()
{
    int count = 0;
    pid_t pid;
    pid = fork();
    if(pid < 0)
        printf("error in fork!\n");
    else if(pid == 0)
        printf("I am the child process,ID is %d,count is %d(%p)\n",
               getpid(),count,&count);
    else 
        printf("I am the parent process,ID is %d,count is %d(%p)\n",
               getpid(),count,&count);
    return 0;
}

// è¾“å‡º
I am the parent process,ID is 5188,count is 0(0x7ffd5e311580)
I am the child process,ID is 5189,count is 1(0x7ffd5e311580)
```

fork\(\)å‡½æ•°ç”¨äºä»å·²å­˜åœ¨çš„è¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œæ–°çš„è¿›ç¨‹ç§°ä¸ºå­è¿›ç¨‹ï¼Œè€ŒåŸè¿›ç¨‹ç§°ä¸ºçˆ¶è¿›ç¨‹ï¼Œ**fork\(\)çš„è¿”å›å€¼æœ‰ä¸¤ä¸ªï¼Œå­è¿›ç¨‹è¿”å›0ï¼Œçˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„è¿›ç¨‹å·ï¼Œè¿›ç¨‹å·éƒ½æ˜¯éé›¶çš„æ­£æ•´æ•°ï¼Œæ‰€ä»¥çˆ¶è¿›ç¨‹è¿”å›çš„å€¼ä¸€å®šå¤§äºé›¶ã€‚**å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹countçš„åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰æ˜¯ç›¸åŒçš„ï¼ˆä½†ä»–ä»¬åœ¨å†…æ ¸ä¸­è¢«æ˜ å°„çš„ç‰©ç†åœ°å€ä¸åŒï¼‰ã€‚

### ğŸ–‹ 2ã€copy-on-write

ç¬¬ä¸€ä»£Unixç³»ç»Ÿä¸­åˆ›å»ºè¿›ç¨‹ï¼šå½“å‘å‡ºfork\(\)ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸åŸæ ·å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ•´ä¸ªåœ°å€ç©ºé—´å¹¶æŠŠå¤åˆ¶çš„é‚£ä¸€ä»½åˆ†é…ç»™å­è¿›ç¨‹ã€‚è¿™ç§è¡Œä¸ºæ˜¯éå¸¸è€—æ—¶çš„ï¼Œå› ä¸ºå®ƒéœ€è¦ï¼š

* ä¸ºå­è¿›ç¨‹çš„é¡µè¡¨åˆ†é…é¡µå¸§
* ä¸ºå­è¿›ç¨‹çš„é¡µåˆ†é…é¡µå¸§
* åˆå§‹åŒ–å­è¿›ç¨‹çš„é¡µè¡¨
* æŠŠçˆ¶è¿›ç¨‹çš„é¡µå¤åˆ¶åˆ°å­è¿›ç¨‹ç›¸åº”çš„é¡µä¸­

è¿™ç§åˆ›å»ºåœ°å€ç©ºé—´çš„æ–¹æ³•æ¶‰åŠè®¸å¤šå†…å­˜è®¿é—®ï¼Œæ¶ˆè€—è®¸å¤šCPUå‘¨æœŸï¼Œå¹¶ä¸”å®Œå…¨ç ´åäº†é«˜é€Ÿç¼“å­˜ä¸­çš„å†…å®¹ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™æ ·åšå¸¸å¸¸æ˜¯æ¯«æ— æ„ä¹‰çš„ï¼Œå› ä¸ºè®¸å¤šå­è¿›ç¨‹é€šè¿‡è£…å…¥ä¸€ä¸ªæ–°çš„ç¨‹åºå¼€å§‹å®ƒä»¬çš„æ‰§è¡Œï¼Œè¿™æ ·å°±å®Œå…¨ä¸¢å¼ƒäº†æ‰€ç»§æ‰¿çš„åœ°å€ç©ºé—´ã€‚

ç°åœ¨çš„Linuxå†…æ ¸é‡‡ç”¨ä¸€ç§æ›´ä¸ºæœ‰æ•ˆçš„æ–¹æ³•ï¼Œç§°ä¹‹ä¸ºå†™æ—¶å¤åˆ¶ï¼ˆCopy On Writeï¼ŒCOWï¼‰ã€‚è¿™ç§æ€æƒ³ç›¸å½“ç®€å•ï¼šçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å…±äº«é¡µå¸§è€Œä¸æ˜¯å¤åˆ¶é¡µå¸§ã€‚ç„¶è€Œï¼Œåªè¦é¡µå¸§è¢«å…±äº«ï¼Œå®ƒä»¬å°±ä¸èƒ½è¢«ä¿®æ”¹ï¼Œå³é¡µå¸§è¢«ä¿æŠ¤ã€‚æ— è®ºçˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ä½•æ—¶è¯•å›¾å†™ä¸€ä¸ªå…±äº«çš„é¡µå¸§ï¼Œå°±äº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™æ—¶å†…æ ¸å°±æŠŠè¿™ä¸ªé¡µå¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„é¡µå¸§ä¸­å¹¶æ ‡è®°ä¸ºå¯å†™ã€‚åŸæ¥çš„é¡µå¸§ä»ç„¶æ˜¯å†™ä¿æŠ¤çš„ï¼šå½“å…¶ä»–è¿›ç¨‹è¯•å›¾å†™å…¥æ—¶ï¼Œå†…æ ¸æ£€æŸ¥å†™è¿›ç¨‹æ˜¯å¦æ˜¯è¿™ä¸ªé¡µå¸§çš„å”¯ä¸€å±ä¸»ï¼Œå¦‚æœæ˜¯ï¼Œå°±æŠŠè¿™ä¸ªé¡µå¸§æ ‡è®°ä¸ºå¯¹è¿™ä¸ªè¿›ç¨‹æ˜¯å¯å†™çš„ã€‚

èµ·åˆå­è¿›ç¨‹å¤åˆ¶äº†çˆ¶è¿›ç¨‹çš„task\_structï¼Œç³»ç»Ÿå †æ ˆç©ºé—´å’Œé¡µé¢è¡¨ï¼Œå­è¿›ç¨‹ä¼šæ‹¥æœ‰ä¸çˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†é¡µé¢ã€‚ä¸ºäº†èŠ‚çº¦å†…å­˜å’ŒåŠ å¿«åˆ›å»ºé€Ÿåº¦çš„ç›®æ ‡ï¼Œfork\(\)å‡½æ•°ä¼šè®©å­è¿›ç¨‹ä»¥åªè¯»æ–¹å¼å…±äº«çˆ¶è¿›ç¨‹çš„ç‰©ç†é¡µé¢ï¼ŒåŒæ—¶å°†çˆ¶è¿›ç¨‹å¯¹è¿™äº›ç‰©ç†é¡µé¢çš„è®¿é—®æƒé™ä¹Ÿè®¾æˆåªè¯»ã€‚è¿™æ ·ï¼Œå½“çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹ä»»ä½•ä¸€æ–¹å¯¹è¿™äº›å·²å…±äº«çš„ç‰©ç†é¡µé¢æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿé¡µé¢å‡ºé”™å¼‚å¸¸\(`page_fault int14`\)ä¸­æ–­ï¼Œæ­¤æ—¶CPUä¼šæ‰§è¡Œç³»ç»Ÿæä¾›çš„å¼‚å¸¸å¤„ç†å‡½æ•°`do_wp_page()`æ¥è§£å†³è¿™ä¸ªå¼‚å¸¸ã€‚`do_wp_page()`ä¼šå¯¹è¿™å—å¯¼è‡´å†™å…¥å¼‚å¸¸ä¸­æ–­çš„ç‰©ç†é¡µé¢è¿›è¡Œå–æ¶ˆå…±äº«æ“ä½œï¼Œä¸ºå†™è¿›ç¨‹å¤åˆ¶ä¸€æ–°çš„ç‰©ç†é¡µé¢ï¼Œä½¿çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹å„è‡ªæ‹¥æœ‰ä¸€å—å†…å®¹ç›¸åŒçš„ç‰©ç†é¡µé¢ã€‚æœ€åï¼Œä»å¼‚å¸¸å¤„ç†å‡½æ•°ä¸­è¿”å›æ—¶ï¼ŒCPUå°±ä¼šé‡æ–°æ‰§è¡Œåˆšæ‰å¯¼è‡´å¼‚å¸¸çš„å†™å…¥æ“ä½œæŒ‡ä»¤ï¼Œä½¿è¿›ç¨‹ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰æ‰§è¡Œ`++count`å‰ï¼Œå…¶å®å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹çš„countæŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜ã€‚è€Œå½“å­è¿›ç¨‹æ”¹å˜äº†å˜é‡æ—¶å€™ï¼ˆå³å¯¹å˜é‡è¿›è¡Œäº†å†™æ“ä½œï¼‰ï¼Œä¼šé€šè¿‡copy\_on\_writeçš„æ‰‹æ®µä¸ºæ‰€æ¶‰åŠçš„é¡µé¢å»ºç«‹ä¸€ä¸ªæ–°çš„å‰¯æœ¬ã€‚æ‰€ä»¥å½“æˆ‘ä»¬æ‰§è¡Œ`++count`åï¼Œè¿™æ—¶å€™å­è¿›ç¨‹æ‰æ–°å»ºäº†ä¸€ä¸ªé¡µé¢å¤åˆ¶åŸæ¥é¡µé¢çš„å†…å®¹ï¼ŒåŸºæœ¬èµ„æºçš„å¤åˆ¶æ˜¯å¿…é¡»çš„ï¼Œè€Œä¸”æ˜¯é«˜æ•ˆçš„ã€‚

**å†™å…¥æ—¶å¤åˆ¶\(Copy-on-write\)**æ˜¯ä¸€ä¸ªè¢«ä½¿ç”¨åœ¨ç¨‹å¼è®¾è®¡é¢†åŸŸçš„æœ€ä½³åŒ–ç­–ç•¥ã€‚å…¶åŸºç¡€çš„è§‚å¿µæ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ªå‘¼å«è€…\(callers\)åŒæ—¶è¦æ±‚ç›¸åŒèµ„æºï¼Œä»–ä»¬ä¼šå…±åŒå–å¾—ç›¸åŒçš„æŒ‡æ ‡æŒ‡å‘ç›¸åŒçš„èµ„æºï¼Œç›´åˆ°æŸä¸ªå‘¼å«è€…\(caller\)å°è¯•ä¿®æ”¹èµ„æºæ—¶ï¼Œç³»ç»Ÿæ‰ä¼šçœŸæ­£å¤åˆ¶ä¸€ä¸ªå‰¯æœ¬\(private copy\)ç»™è¯¥å‘¼å«è€…ï¼Œä»¥é¿å…è¢«ä¿®æ”¹çš„èµ„æºè¢«ç›´æ¥å¯Ÿè§‰åˆ°ï¼Œè¿™è¿‡ç¨‹å¯¹å…¶ä»–çš„å‘¼å«éƒ½æ˜¯é€šé€çš„\(transparently\)ã€‚æ­¤ä½œæ³•ä¸»è¦çš„ä¼˜ç‚¹æ˜¯å¦‚æœå‘¼å«è€…å¹¶æ²¡æœ‰ä¿®æ”¹è¯¥èµ„æºï¼Œå°±ä¸ä¼šæœ‰å‰¯æœ¬\(private copy\)è¢«å»ºç«‹ã€‚

### ğŸ–‹ 3ã€`vfork`å‡½æ•°

`vfork`åˆ›å»ºçš„å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«åœ°å€ç©ºé—´ï¼Œå³å­è¿›ç¨‹å®Œå…¨è¿è¡Œåœ¨çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸Šï¼Œå­è¿›ç¨‹å¯¹è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¿®æ”¹åŒæ ·ä¸ºçˆ¶è¿›ç¨‹æ‰€è§ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç”¨`vfork`å‡½æ•°åˆ›å»ºå­è¿›ç¨‹åï¼Œå­è¿›ç¨‹å¾€å¾€è¦è°ƒç”¨ä¸€ç§execå‡½æ•°ä»¥æ‰§è¡Œå¦ä¸€ä¸ªç¨‹åºï¼Œå½“è¿›ç¨‹è°ƒç”¨ä¸€ç§execå‡½æ•°æ—¶ï¼Œè¯¥è¿›ç¨‹å®Œå…¨ç”±æ–°ç¨‹åºä»£æ¢ï¼Œè€Œæ–°ç¨‹åºåˆ™ä»å…¶mainå‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œå› ä¸ºè°ƒç”¨execå¹¶ä¸åˆ›å»ºæ–°è¿›ç¨‹ï¼Œæ‰€ä»¥å‰åçš„è¿›ç¨‹id å¹¶æœªæ”¹å˜ï¼Œexecåªæ˜¯ç”¨å¦ä¸€ä¸ªæ–°ç¨‹åºæ›¿æ¢äº†å½“å‰è¿›ç¨‹çš„æ­£æ–‡ï¼Œæ•°æ®ï¼Œå †å’Œæ ˆæ®µã€‚ä¸è¿‡åœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨execæˆ–exitä¹‹å‰ï¼Œä»–åœ¨çˆ¶è¿›ç¨‹çš„ç©ºé—´ä¸­è¿è¡Œã€‚

```cpp
#include<sys/types.h>
#include<unistd.h>
#include<stdio.h>

int main()
{
    pid_t pid;
    int cnt = 0;
    pid = vfork();
    if(pid<0)
        printf("error in fork!\n");
    else if(pid == 0)
    {
        cnt++;
        printf("cnt=%d\n",cnt);
        printf("I am the child process,ID is %d\n",getpid());
        _exit(0); // _exit(0);
    }
    else if(pid > 0)
    {
        cnt++;
        printf("cnt=%d\n",cnt);
        printf("I am the parent process,ID is %d\n",getpid());
    }
    return 0;
}

// è¾“å‡º
cnt=1
I am the child process,ID is 19713
cnt=2
I am the parent process,ID is 19712

// å¦‚æœæ³¨é‡Šæ‰ __exit(0)ï¼Œåˆ™ä¼šå‡ºç°ä¸€ä¸‹é”™è¯¯ï¼š
cnt=1
I am the child process,ID is 13986
cnt=-134746042
I am the parent process,ID is 13985
test_vfork: cxa_atexit.c:100: __new_exitfn: Assertion `l != NULL' failed.
[1]    13985 abort (core dumped)  ./test_vfork
```

### ğŸ–‹ 4ã€åŒºåˆ«

1. `fork()`çš„å­è¿›ç¨‹æ‹·è´çˆ¶è¿›ç¨‹çš„æ•°æ®æ®µå’Œä»£ç æ®µï¼› `vfork()`çš„å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«æ•°æ®æ®µï¼›
2. `fork()`çš„çˆ¶å­è¿›ç¨‹çš„æ‰§è¡Œæ¬¡åºä¸ç¡®å®šï¼› `vfork()`ä¿è¯å­è¿›ç¨‹å…ˆè¿è¡Œï¼Œåœ¨è°ƒç”¨ `exec` æˆ– `exit` ä¹‹

   å‰ä¸çˆ¶è¿›ç¨‹æ•°æ®æ˜¯å…±äº«çš„ï¼Œåœ¨å®ƒè°ƒç”¨ `exec` æˆ– `exit` ä¹‹åçˆ¶è¿›ç¨‹æ‰å¯èƒ½è¢«è°ƒåº¦è¿è¡Œï¼›

3. `vfork()`ä¿è¯å­è¿›ç¨‹å…ˆè¿è¡Œï¼Œåœ¨å®ƒè°ƒç”¨ exec æˆ– exit ä¹‹åçˆ¶è¿›ç¨‹æ‰å¯èƒ½è¢«è°ƒåº¦è¿è¡Œã€‚å¦‚æœ

   åœ¨è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°ä¹‹å‰å­è¿›ç¨‹ä¾èµ–äºçˆ¶è¿›ç¨‹çš„è¿›ä¸€æ­¥åŠ¨ä½œï¼Œåˆ™ä¼šå¯¼è‡´æ­»é”ã€‚

## âœ 2ã€execå®¶æ—

## âœ 3ã€`exit & __exit`

## âœ 4ã€`wait & waitpid`

## âœ 5ã€clone

